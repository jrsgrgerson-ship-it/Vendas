<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY BABY | COMISS√ïES V16</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* TEMA MIDNIGHT CALM (Azul Noite + Neon Suave) */
            --bg-body: #0f172a;       /* Azul profundo */
            --bg-card: #1e293b;       /* Azul acinzentado */
            --text-main: #f1f5f9;     /* Branco gelo */
            --text-muted: #94a3b8;    /* Cinza azulado */
            
            /* NEON SUAVE */
            --accent: #38bdf8;        /* Azul C√©u Neon */
            --success: #4ade80;       /* Verde Lima Neon */
            --danger: #f87171;        /* Vermelho Suave */
            --warning: #fbbf24;       /* Amarelo Ouro */
            
            --glow: 0 0 20px rgba(56, 189, 248, 0.15); /* Brilho leve */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        
        body { 
            background: var(--bg-body); color: var(--text-main); 
            padding: 20px; min-height: 100vh;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        /* --- CABE√áALHO --- */
        header {
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px;
            gap: 15px;
        }
        
        .logo h1 { font-weight: 800; font-size: 24px; letter-spacing: 1px; }
        .logo span { color: var(--accent); text-shadow: var(--glow); }
        .logo p { color: var(--text-muted); font-size: 12px; font-weight: 300; }

        .toolbar { display: flex; gap: 10px; }
        .btn-tool {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-muted); padding: 8px 16px; border-radius: 8px; cursor: pointer;
            font-size: 13px; font-weight: 500; transition: 0.3s;
        }
        .btn-tool:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: var(--accent); }
        .btn-pdf { background: var(--accent); color: #0f172a; border: none; font-weight: 700; }
        .btn-pdf:hover { box-shadow: 0 0 15px var(--accent); color: #000; }

        /* --- MINI STATS (Contadores) --- */
        .stats-mini {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 15px; margin-bottom: 25px;
        }
        .stat-badge {
            background: var(--bg-card); padding: 15px; border-radius: 12px;
            display: flex; align-items: center; justify-content: space-between;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .sb-icon { font-size: 18px; }
        .sb-info div { font-size: 10px; color: var(--text-muted); text-transform: uppercase; font-weight: 700; }
        .sb-info span { font-size: 18px; font-weight: 700; color: #fff; }

        /* --- DASHBOARD FINANCEIRO (Cards Grandes) --- */
        .finance-row {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .card {
            background: var(--bg-card); padding: 25px; border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.05); position: relative; overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .card h3 { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .card .value { font-size: 28px; font-weight: 700; display: block; margin-bottom: 5px; }
        .card .sub { font-size: 12px; opacity: 0.6; }

        /* Cores Espec√≠ficas */
        .c-blue .value { color: var(--accent); text-shadow: 0 0 10px rgba(56, 189, 248, 0.3); }
        .c-red .value { color: var(--danger); }
        .c-green { background: linear-gradient(145deg, #1e293b, #064e3b); border: 1px solid var(--success); }
        .c-green .value { color: var(--success); text-shadow: 0 0 15px rgba(74, 222, 128, 0.4); }

        /* --- GR√ÅFICO --- */
        .chart-box {
            background: var(--bg-card); padding: 20px; border-radius: 16px;
            height: 300px; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.05);
        }

        /* --- INPUTS --- */
        .control-panel {
            background: #182235; padding: 20px; border-radius: 16px; margin-bottom: 30px;
            display: flex; gap: 10px; flex-wrap: wrap; align-items: center; border: 1px solid rgba(255,255,255,0.05);
        }
        input, select {
            background: #0f172a; border: 1px solid #334155; color: #fff;
            padding: 12px 15px; border-radius: 8px; outline: none; font-size: 14px;
        }
        input:focus { border-color: var(--accent); }
        
        .btn-main {
            background: var(--accent); color: #0f172a; border: none; padding: 12px 25px;
            border-radius: 8px; font-weight: 700; cursor: pointer; flex-grow: 1; transition: 0.2s;
        }
        .btn-main:hover { filter: brightness(1.2); }

        .btn-vale-act {
            background: transparent; border: 1px solid var(--danger); color: var(--danger);
            padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;
        }
        .btn-vale-act:hover { background: var(--danger); color: #fff; }

        /* --- TABELA --- */
        .table-wrap { overflow-x: auto; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); }
        table { width: 100%; border-collapse: collapse; background: var(--bg-card); }
        th { text-align: left; padding: 18px; color: var(--text-muted); font-size: 11px; text-transform: uppercase; border-bottom: 1px solid #334155; }
        td { padding: 18px; border-bottom: 1px solid #334155; font-size: 14px; color: var(--text-main); }
        
        /* Status Tags */
        .tag { padding: 5px 10px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .t-ok { background: rgba(74, 222, 128, 0.1); color: var(--success); border: 1px solid var(--success); }
        .t-cancel { background: rgba(251, 191, 36, 0.1); color: var(--warning); border: 1px solid var(--warning); }
        .t-vale { color: var(--danger); font-weight: bold; }

        /* A√ß√µes */
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 16px; opacity: 0.6; transition: 0.2s; padding: 5px; }
        .btn-icon:hover { opacity: 1; transform: scale(1.1); }

        /* IMPRESS√ÉO PDF */
        @media print {
            body { background: #fff; color: #000; -webkit-print-color-adjust: exact; }
            .no-print, .toolbar, .control-panel, .btn-vale-act { display: none !important; }
            .card, .table-wrap, .stat-badge, .chart-box { 
                background: #fff; border: 1px solid #ccc; color: #000; box-shadow: none; 
            }
            .value { color: #000 !important; text-shadow: none !important; }
            h1, span, p { color: #000 !important; text-shadow: none !important; }
            table { color: #000; }
            th { color: #000; border-bottom: 2px solid #000; }
            td { border-bottom: 1px solid #eee; }
            
            /* Header Impress√£o */
            #print-head { display: block !important; margin-bottom: 20px; text-align: center; border: 2px solid #000; padding: 20px; }
        }
        #print-head { display: none; }
    </style>
</head>
<body>

<div class="container">

    <div id="print-head">
        <h2>RELAT√ìRIO DE VENDAS & COMISS√ïES</h2>
        <p>Vendedor: <b>Gerson</b> | Data do Relat√≥rio: <span id="data-rel"></span></p>
    </div>

    <header class="no-print">
        <div class="logo">
            <h1>MY BABY <span>MANAGER</span></h1>
            <p>Painel de Controle de Comiss√µes | V16 (Est√°vel)</p>
        </div>
        <div class="toolbar">
            <input type="file" id="importFile" hidden onchange="importarDados(this)">
            <button class="btn-tool" onclick="document.getElementById('importFile').click()">üìÇ Restaurar Backup</button>
            <button class="btn-tool" onclick="exportarDados()">üíæ Salvar Dados</button>
            <button class="btn-tool btn-pdf" onclick="window.print()">üñ®Ô∏è PDF Digital</button>
        </div>
    </header>

    <div class="stats-mini">
        <div class="stat-badge">
            <div class="sb-info"><div>Spitz</div><span id="c-spitz">0</span></div>
            <div class="sb-icon">üê∂</div>
        </div>
        <div class="stat-badge">
            <div class="sb-info"><div>Bengal</div><span id="c-bengal">0</span></div>
            <div class="sb-icon">üêØ</div>
        </div>
        <div class="stat-badge">
            <div class="sb-info"><div>Machos</div><span id="c-m">0</span></div>
            <div class="sb-icon" style="color:#38bdf8">üíô</div>
        </div>
        <div class="stat-badge">
            <div class="sb-info"><div>F√™meas</div><span id="c-f">0</span></div>
            <div class="sb-icon" style="color:#f472b6">üíñ</div>
        </div>
    </div>

    <div class="finance-row">
        <div class="card c-blue">
            <h3>Vendas + Sinais (Bruto)</h3>
            <span class="value" id="v-bruto">R$ 0,00</span>
            <span class="sub" id="v-qtd">0 Registros</span>
        </div>
        <div class="card">
            <h3>Total Vales</h3>
            <span class="value" style="color:var(--danger)" id="v-vales">R$ 0,00</span>
            <span class="sub">Descontado do L√≠quido</span>
        </div>
        <div class="card">
            <h3>Comiss√£o Total</h3>
            <span class="value" style="color:#fff" id="v-comissao">R$ 0,00</span>
            <span class="sub">Sal√°rio (2k) + 3%</span>
        </div>
        <div class="card c-green">
            <h3>üí∞ L√≠quido a Receber</h3>
            <span class="value" id="v-liquido">R$ 0,00</span>
            <span class="sub">Dispon√≠vel para saque</span>
        </div>
    </div>

    <div class="chart-box no-print">
        <canvas id="waveChart"></canvas>
    </div>

    <div class="control-panel no-print">
        <select id="inRaca">
            <option value="Spitz">Spitz Alem√£o</option>
            <option value="Bengal">Gato Bengal</option>
            <option value="Outros">Outros</option>
        </select>
        <select id="inSexo" style="width: 100px;">
            <option value="M">Macho</option>
            <option value="F">F√™mea</option>
        </select>
        <input type="text" id="inCli" placeholder="Nome do Cliente" style="flex-grow: 2; min-width: 150px;">
        <input type="number" id="inVal" placeholder="Valor R$" style="width: 120px;">
        
        <button class="btn-main" onclick="addVenda()">LAN√áAR VENDA</button>
        <button class="btn-vale-act" onclick="addVale()">REGISTRAR VALE</button>
    </div>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Status</th>
                    <th>Cliente / Detalhes</th>
                    <th>Valor Transa√ß√£o</th>
                    <th>Comiss√£o (3%)</th>
                    <th class="no-print" style="text-align:right">A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="lista-corpo"></tbody>
        </table>
    </div>

</div>

<script>
    // CHAVE MESTRA
    const KEY = 'MYBABY_V16_MASTER';
    let db = { vendas: [] };
    let chartObj = null;

    // --- 1. SISTEMA DE RESGATE PROFUNDO (Deep Recovery) ---
    function initSystem() {
        const stored = localStorage.getItem(KEY);
        
        if (stored) {
            // Se j√° tem dados na V16, usa eles
            db = JSON.parse(stored);
        } else {
            // Se n√£o tem, PROCURA nas vers√µes antigas
            console.log("Iniciando busca profunda de dados...");
            const oldKeys = [
                'MYBABY_FINAL_SYSTEM_V15', 
                'NEON_PRIME_DATA_V14', 
                'GERSON_COMISSOES_V13',
                'MY_BABY_V12_SYSTEM',
                'MY_BABY_V11_FINAL'
            ];
            
            let recoveredData = [];
            
            oldKeys.forEach(k => {
                const raw = localStorage.getItem(k);
                if(raw) {
                    try {
                        const parsed = JSON.parse(raw);
                        const list = Array.isArray(parsed) ? parsed : (parsed.vendas || []);
                        recoveredData = [...recoveredData, ...list];
                    } catch(e){}
                }
            });

            // Remove duplicados pelo ID
            const unique = [];
            const map = new Map();
            recoveredData.forEach(item => {
                if(!map.has(item.id)){
                    map.set(item.id, true);
                    unique.push(item);
                }
            });

            if (unique.length > 0) {
                db.vendas = unique;
                alert(`Sucesso! Recuperamos ${unique.length} registros das vers√µes anteriores.`);
                save(); // Salva na nova chave
            }
        }
        
        document.getElementById('data-rel').innerText = new Date().toLocaleDateString();
        render();
    }

    function save() {
        localStorage.setItem(KEY, JSON.stringify(db));
        render();
    }

    // --- 2. FUN√á√ïES DE ARQUIVO ---
    function exportarDados() {
        const dataStr = JSON.stringify(db);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `MyBaby_Backup_${new Date().toLocaleDateString().replace(/\//g,'-')}.json`;
        a.click();
    }

    function importarDados(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                if(json.vendas || Array.isArray(json)) {
                    db = json.vendas ? json : { vendas: json };
                    save();
                    alert("Dados restaurados com sucesso!");
                }
            } catch(e) { alert("Erro no arquivo."); }
        };
        reader.readAsText(file);
    }

    // --- 3. L√ìGICA DE NEG√ìCIO ---
    function addVenda() {
        const cli = document.getElementById('inCli').value;
        const val = parseFloat(document.getElementById('inVal').value);
        if(cli && val) {
            db.vendas.push({
                id: Date.now(),
                data: new Date().toLocaleDateString('pt-BR').substring(0,5),
                tipo: 'venda',
                cliente: cli,
                raca: document.getElementById('inRaca').value,
                sexo: document.getElementById('inSexo').value,
                valor: val,
                cancelada: false
            });
            document.getElementById('inCli').value = '';
            document.getElementById('inVal').value = '';
            save();
        }
    }

    function addVale() {
        const val = prompt("Valor do Vale/Adiantamento:");
        if(val) {
            db.vendas.push({
                id: Date.now(),
                data: new Date().toLocaleDateString('pt-BR').substring(0,5),
                tipo: 'vale',
                cliente: 'ADIANTAMENTO',
                valor: parseFloat(val)
            });
            save();
        }
    }

    function toggleStatus(id) {
        const item = db.vendas.find(x => x.id === id);
        if(item) {
            item.cancelada = !item.cancelada;
            save();
        }
    }

    function excluir(id) {
        if(confirm("Excluir este registro?")) {
            db.vendas = db.vendas.filter(x => x.id !== id);
            save();
        }
    }

    // --- 4. RENDERIZA√á√ÉO ---
    function render() {
        const tbody = document.getElementById('lista-corpo');
        tbody.innerHTML = '';

        let finance = { bruto: 0, vales: 0, comissaoFixa: 2000, comissaoVar: 0 };
        let stats = { spitz: 0, bengal: 0, m: 0, f: 0 };
        let graphLabels = [];
        let graphData = [];

        // Ordenar cronologicamente para gr√°fico
        const sorted = [...db.vendas].sort((a,b) => a.id - b.id);

        sorted.forEach(v => {
            if(v.tipo === 'vale') {
                finance.vales += v.valor;
            } else {
                // SOMA TUDO (Ativo ou Cancelado/Sinal)
                finance.bruto += v.valor;
                finance.comissaoVar += (v.valor * 0.03);

                if(v.raca === 'Spitz') stats.spitz++;
                if(v.raca === 'Bengal') stats.bengal++;
                if(v.sexo === 'M') stats.m++;
                if(v.sexo === 'F') stats.f++;

                graphLabels.push(v.data);
                graphData.push(v.valor);
            }
        });

        const totalComissao = finance.comissaoFixa + finance.comissaoVar;
        const liquido = totalComissao - finance.vales;

        // Atualiza UI
        document.getElementById('c-spitz').innerText = stats.spitz;
        document.getElementById('c-bengal').innerText = stats.bengal;
        document.getElementById('c-m').innerText = stats.m;
        document.getElementById('c-f').innerText = stats.f;

        document.getElementById('v-bruto').innerText = `R$ ${finance.bruto.toLocaleString('pt-BR')}`;
        document.getElementById('v-qtd').innerText = `${sorted.filter(x=>x.tipo!='vale').length} Vendas`;
        document.getElementById('v-vales').innerText = `R$ ${finance.vales.toLocaleString('pt-BR')}`;
        document.getElementById('v-comissao').innerText = `R$ ${totalComissao.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
        document.getElementById('v-liquido').innerText = `R$ ${liquido.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;

        // Tabela (Invertida: Recentes primeiro)
        [...sorted].reverse().forEach(v => {
            if(v.tipo === 'vale') {
                tbody.innerHTML += `
                    <tr style="background:rgba(248, 113, 113, 0.05)">
                        <td>${v.data}</td>
                        <td><span class="tag t-vale">VALE</span></td>
                        <td style="color:var(--danger)"><b>ADIANTAMENTO</b></td>
                        <td style="color:var(--danger)">- R$ ${v.valor.toLocaleString()}</td>
                        <td>-</td>
                        <td class="no-print" style="text-align:right">
                            <button class="btn-icon" onclick="excluir(${v.id})">üóë</button>
                        </td>
                    </tr>`;
            } else {
                const isCancel = v.cancelada;
                const badge = isCancel 
                    ? `<span class="tag t-cancel">‚ö†Ô∏è SINAL / CANCEL</span>` 
                    : `<span class="tag t-ok">‚úÖ ENTREGUE</span>`;
                
                const valDisplay = isCancel
                    ? `<span style="text-decoration:line-through; opacity:0.5; font-size:11px">R$ ${v.valor.toLocaleString()}</span> <span style="color:var(--warning); font-weight:bold; font-size:12px">SINAL PAGO</span>`
                    : `R$ ${v.valor.toLocaleString()}`;

                tbody.innerHTML += `
                    <tr style="${isCancel ? 'opacity:0.8' : ''}">
                        <td>${v.data}</td>
                        <td>${badge}</td>
                        <td>
                            <b>${v.cliente}</b> <small style="color:var(--text-muted)">| ${v.raca}</small>
                        </td>
                        <td>${valDisplay}</td>
               
