<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Baby - Sistema Final</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; color: #1a1a1a; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        h1 { font-weight: 800; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }

        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { padding: 20px; border-radius: 10px; background: #fff; border: 1px solid #e9ecef; }
        .card h3 { margin: 0; font-size: 11px; text-transform: uppercase; color: #6c757d; letter-spacing: 1px; }
        .card p { margin: 10px 0 0; font-size: 22px; font-weight: 800; }
        .card.destaque { background: #1a1a1a; color: #fff; border: none; }
        .card.destaque .valor { color: #00ff88; }

        .chart-box { height: 200px; margin-bottom: 30px; }

        .form-box { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; flex: 1; min-width: 150px; }
        .btn-add { background: #007bff; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 700; cursor: pointer; }
        .btn-vale { background: #fff; color: #dc3545; border: 1px solid #dc3545; padding: 8px; width: 100%; border-radius: 6px; font-weight: 700; cursor: pointer; margin-bottom: 20px; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; background: #f1f3f5; color: #495057; font-size: 12px; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: middle; }
        
        .cancelada { color: #adb5bd; }
        .cancelada .bruto { text-decoration: line-through; }
        
        .btn-group { display: flex; gap: 5px; }
        .btn-acao { padding: 5px 10px; border: 1px solid #dee2e6; background: #fff; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-acao:hover { background: #f8f9fa; }
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 800; margin-left: 5px; }
        .tag-red { background: #fff0f0; color: #dc3545; }
        .tag-green { background: #e6fffa; color: #28a745; }
    </style>
</head>
<body>

<div class="container">
    <h1>My Baby Premium</h1>

    <div class="dashboard">
        <div class="card">
            <h3>Faturamento (Ativo)</h3>
            <p id="fatDisplay">R$ 0,00</p>
        </div>
        <div class="card destaque">
            <h3>Saldo Gerson (Fixo + 3%)</h3>
            <p class="valor" id="saldoDisplay">R$ 0,00</p>
            <small id="comissaoTotalInfo" style="font-size: 10px; color: #888;">Comiss√µes: R$ 0,00</small>
        </div>
        <div class="card">
            <h3>Vales</h3>
            <p style="color: #dc3545;" id="valesDisplay">R$ 0,00</p>
        </div>
    </div>

    <div class="chart-box">
        <canvas id="graficoDinamico"></canvas>
    </div>

    <div class="form-box">
        <select id="tipo">
            <option value="Spitz Alem√£o">üê∂ Spitz Alem√£o</option>
            <option value="Gato Bengal">üê± Gato Bengal</option>
        </select>
        <input type="text" id="cliente" placeholder="Cliente">
        <input type="number" id="valor" placeholder="Valor R$">
        <button class="btn-add" onclick="lancarVenda()">Lan√ßar</button>
    </div>
    <button class="btn-vale" onclick="lancarVale()">+ Registrar Vale</button>

    <table>
        <thead>
            <tr>
                <th>Data</th>
                <th>Cliente / Pet</th>
                <th>Valor Bruto</th>
                <th>Comiss√£o (3%)</th>
                <th style="width: 100px;">A√ß√µes</th>
            </tr>
        </thead>
        <tbody id="listaVendas"></tbody>
    </table>
</div>

<script>
    let vendas = JSON.parse(localStorage.getItem('vendasV5')) || [];
    let chart = null;

    function salvar() {
        localStorage.setItem('vendasV5', JSON.stringify(vendas));
        render();
    }

    function lancarVenda() {
        const c = document.getElementById('cliente').value;
        const v = parseFloat(document.getElementById('valor').value);
        if(c && v) {
            vendas.push({
                data: new Date().toLocaleDateString('pt-BR').substring(0, 5),
                cliente: c,
                tipo: document.getElementById('tipo').value,
                valor: v,
                cancelada: false,
                isVale: false
            });
            document.getElementById('cliente').value = '';
            document.getElementById('valor').value = '';
            salvar();
        }
    }

    function lancarVale() {
        const v = prompt("Valor do Vale:");
        if(v) {
            vendas.push({
                data: new Date().toLocaleDateString('pt-BR').substring(0, 5),
                cliente: "VALE",
                valor: parseFloat(v),
                isVale: true
            });
            salvar();
        }
    }

    function deletar(i) { if(confirm("Apagar?")) { vendas.splice(i, 1); salvar(); } }
    function toggle(i) { vendas[i].cancelada = !vendas[i].cancelada; salvar(); }

    function render() {
        const corpo = document.getElementById('listaVendas');
        corpo.innerHTML = '';
        
        let totalC = 0; // Comiss√£o
        let totalV = 0; // Vales
        let fatA = 0;   // Faturamento Ativo
        let pts = {};   // Pontos do gr√°fico

        // MATEM√ÅTICA SEM ERRO: Percorre tudo uma vez s√≥
        vendas.forEach((item, i) => {
            if(item.isVale) {
                totalV += item.valor;
            } else {
                // REGRA DE OURO: Adiciona 3% de TODA venda, cancelada ou n√£o.
                totalC += (item.valor * 0.03);
                
                if(!item.cancelada) {
                    fatA += item.valor;
                    pts[item.data] = (pts[item.data] || 0) + item.valor;
                }
            }
        });

        // SALDO: Fixo (2000) + Todas as Comiss√µes - Vales
        const saldoFinal = 2000 + totalC - totalV;

        // Dashboard
        document.getElementById('fatDisplay').innerText = `R$ ${fatA.toLocaleString()}`;
        document.getElementById('saldoDisplay').innerText = `R$ ${saldoFinal.toLocaleString()}`;
        document.getElementById('valesDisplay').innerText = `R$ ${totalV.toLocaleString()}`;
        document.getElementById('comissaoTotalInfo').innerText = `3% de Todas as Vendas: R$ ${totalC.toLocaleString()}`;

        // Lista (Invertida para o mais novo no topo)
        [...vendas].reverse().forEach((item, revIdx) => {
            const i = vendas.length - 1 - revIdx;
            if(item.isVale) {
                corpo.innerHTML += `<tr style="background:#fff5f5"><td>${item.data}</td><td style="color:#dc3545; font-weight:800">üí∏ VALE</td><td style="color:#dc3545">- R$ ${item.valor.toLocaleString()}</td><td>-</td><td><button class="btn-acao" onclick="deletar(${i})">üóëÔ∏è</button></td></tr>`;
            } else {
                corpo.innerHTML += `
                    <tr class="${item.cancelada ? 'cancelada' : ''}">
                        <td>${item.data}</td>
                        <td>
                            <b>${item.cliente}</b> <small>(${item.tipo})</small>
                            ${item.cancelada ? '<span class="tag tag-red">CANCEL</span>' : '<span class="tag tag-green">OK</span>'}
                        </td>
                        <td class="bruto">R$ ${item.valor.toLocaleString()}</td>
                        <td style="color:#28a745; font-weight:700">+ R$ ${(item.valor * 0.03).toLocaleString()}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn-acao" onclick="toggle(${i})">üö´</button>
                                <button class="btn-acao" onclick="deletar(${i})">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>`;
            }
        });
        updateChart(pts);
    }

    function updateChart(dados) {
        const ctx = document.getElementById('graficoDinamico').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Object.keys(dados),
                datasets: [{
                    data: Object.values(dados),
                    borderColor: '#007bff',
                    borderWidth: 3,
                    tension: 0.4,
                    pointRadius: 0,
                    fill: true,
                    backgroundColor: 'rgba(0, 123, 255, 0.05)'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
        });
    }
    render();
</script>
</body>
</html>
