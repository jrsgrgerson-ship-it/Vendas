<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Comercial | V15</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* Palette Soft Neon */
            --bg: #f4f7fc;
            --surface: #ffffff;
            --text: #2d3436;
            
            /* Cores Vibrantes (Neon Leve) */
            --primary: #6c5ce7; /* Roxo Suave */
            --primary-glow: rgba(108, 92, 231, 0.4);
            
            --accent: #00cec9; /* Ciano */
            --accent-glow: rgba(0, 206, 201, 0.4);
            
            --success: #00b894; /* Verde Menta */
            --success-glow: rgba(0, 184, 148, 0.4);
            
            --danger: #ff7675; /* Salm√£o/Vermelho Suave */
            --danger-glow: rgba(255, 118, 117, 0.4);
            
            --warning: #fdcb6e; /* Amarelo Sol */
            --warning-glow: rgba(253, 203, 110, 0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        body { 
            background: var(--bg); color: var(--text); padding: 30px; 
            -webkit-print-color-adjust: exact; print-color-adjust: exact; 
        }

        .container { max-width: 1200px; margin: 0 auto; }

        /* HEADER */
        header { 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; 
            background: var(--surface); padding: 20px 30px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        h1 { font-weight: 700; font-size: 24px; color: var(--text); letter-spacing: -0.5px; }
        h1 span { color: var(--primary); text-shadow: 0 0 15px var(--primary-glow); }

        .toolbar { display: flex; gap: 10px; }
        .btn-tool {
            background: #f0f3f7; border: none; padding: 10px 15px; border-radius: 12px;
            font-weight: 600; color: #636e72; cursor: pointer; transition: 0.2s; font-size: 13px;
            display: flex; align-items: center; gap: 5px;
        }
        .btn-tool:hover { background: #dfe6e9; color: var(--primary); }
        
        .btn-pdf { 
            background: linear-gradient(135deg, var(--primary), #a29bfe); color: white; 
            box-shadow: 0 4px 15px var(--primary-glow);
        }
        .btn-pdf:hover { transform: translateY(-2px); }

        /* STATS MINI */
        .stats-strip {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;
        }
        .mini-card {
            background: var(--surface); padding: 15px; border-radius: 16px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.03); border: 1px solid rgba(255,255,255,0.5);
        }
        .mini-icon { font-size: 20px; background: #f1f2f6; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 12px; }
        .mini-val { font-size: 20px; font-weight: 700; color: var(--text); }
        .mini-label { font-size: 11px; color: #b2bec3; font-weight: 600; text-transform: uppercase; }

        /* FINANCE DASHBOARD */
        .finance-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; margin-bottom: 30px;
        }
        .card {
            background: var(--surface); padding: 25px; border-radius: 24px; position: relative; overflow: hidden;
            box-shadow: 0 15px 35px rgba(0,0,0,0.05); transition: 0.3s;
        }
        .card h3 { font-size: 12px; color: #b2bec3; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; margin-bottom: 5px; }
        .card .value { font-size: 32px; font-weight: 700; display: block; margin-bottom: 5px; }
        .card .sub { font-size: 12px; opacity: 0.7; font-weight: 500; }

        /* Estilos Espec√≠ficos dos Cards */
        .c-bruto .value { color: var(--primary); text-shadow: 0 0 20px var(--primary-glow); }
        .c-vale .value { color: var(--danger); text-shadow: 0 0 20px var(--danger-glow); }
        
        .c-liquido { 
            background: linear-gradient(135deg, var(--success), #55efc4); color: white; 
            box-shadow: 0 10px 30px var(--success-glow); border: none;
        }
        .c-liquido h3 { color: rgba(255,255,255,0.8); }
        .c-liquido .value { color: white; text-shadow: none; }
        .c-liquido .sub { color: rgba(255,255,255,0.9); }

        /* CHART */
        .chart-wrapper {
            background: var(--surface); padding: 20px; border-radius: 24px; margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.03); height: 320px; position: relative;
        }

        /* INPUTS */
        .input-bar {
            background: var(--surface); padding: 10px; border-radius: 20px; margin-bottom: 30px;
            display: flex; gap: 10px; flex-wrap: wrap; box-shadow: 0 5px 20px rgba(0,0,0,0.04);
            align-items: center;
        }
        input, select {
            border: none; background: #f5f6fa; padding: 15px 20px; border-radius: 14px;
            font-weight: 600; color: var(--text); outline: none; font-size: 14px;
        }
        input::placeholder { color: #b2bec3; }
        input:focus { background: #fff; box-shadow: inset 0 0 0 2px var(--primary); }

        .btn-add {
            background: var(--primary); color: white; border: none; padding: 15px 30px;
            border-radius: 14px; font-weight: 600; cursor: pointer; flex-grow: 1;
            box-shadow: 0 5px 15px var(--primary-glow); transition: 0.2s;
        }
        .btn-add:hover { transform: scale(1.02); }

        .btn-vale-action {
            background: #ffeaa7; color: #d63031; padding: 15px 20px; border-radius: 14px;
            font-weight: 700; border: none; cursor: pointer; margin-left: auto;
        }

        /* TABELA */
        .table-container { background: var(--surface); border-radius: 24px; padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { text-align: left; padding: 20px; color: #b2bec3; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        td { padding: 20px; border-bottom: 1px solid #f5f6fa; font-size: 14px; font-weight: 600; color: var(--text); vertical-align: middle; }
        
        /* Badges */
        .badge { padding: 6px 12px; border-radius: 8px; font-size: 10px; text-transform: uppercase; font-weight: 700; display: inline-block; }
        .b-ok { background: rgba(0, 184, 148, 0.1); color: var(--success); }
        .b-cancel { background: rgba(253, 203, 110, 0.15); color: #e17055; }
        .b-vale { background: rgba(255, 118, 117, 0.1); color: var(--danger); }

        /* Linhas Especiais */
        .row-vale td { color: #d63031; }
        .row-cancel td { opacity: 0.8; }
        .row-cancel .val-riscado { text-decoration: line-through; color: #b2bec3; font-size: 11px; margin-right: 5px; }
        .row-cancel .val-sinal { color: #e17055; }

        /* Bot√µes A√ß√£o */
        .act-btn { width: 32px; height: 32px; border-radius: 8px; border: none; background: #f1f2f6; color: #636e72; cursor: pointer; transition: 0.2s; }
        .act-btn:hover { background: var(--primary); color: white; }

        /* MODO PDF DIGITAL */
        @media print {
            .no-print, .input-bar, .btn-vale-action, .toolbar { display: none !important; }
            body { background: #fff; padding: 0; margin: 0; }
            .container { width: 100%; max-width: 100%; margin: 0; padding: 20px; }
            .finance-grid { grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
            .card { border: 1px solid #eee; box-shadow: none; break-inside: avoid; }
            .chart-wrapper { border: 1px solid #eee; box-shadow: none; height: 300px; break-inside: avoid; }
            .table-container { box-shadow: none; border: 1px solid #eee; }
            h1 { font-size: 28px; margin-bottom: 10px; }
            /* Preservar background das badges */
            .b-ok { background: #def7f0 !important; color: #00b894 !important; }
            .b-cancel { background: #fff8e1 !important; color: #e17055 !important; }
            .c-liquido { background: #00b894 !important; color: white !important; print-color-adjust: exact; }
            
            #headerPDF { display: block !important; margin-bottom: 20px; text-align: center; }
        }
        #headerPDF { display: none; }
    </style>
</head>
<body>

<div class="container">
    
    <div id="headerPDF">
        <h2>RELAT√ìRIO GERENCIAL</h2>
        <p>Painel de Comiss√µes | Vendedor: Gerson | Data: <span id="dataPrint"></span></p>
    </div>

    <header class="no-print">
        <div>
            <h1>Painel <span>Vendas & Pets</span></h1>
            <p style="font-size:12px; color:#b2bec3; font-weight:500">Gest√£o de Comiss√µes e Reservas</p>
        </div>
        <div class="toolbar">
            <input type="file" id="fileIn" hidden onchange="importData(this)">
            <button class="btn-tool" onclick="document.getElementById('fileIn').click()">üìÇ Importar</button>
            <button class="btn-tool" onclick="exportData()">üíæ Backup</button>
            <button class="btn-tool btn-pdf" onclick="window.print()">‚ú® Gerar PDF Digital</button>
        </div>
    </header>

    <div class="stats-strip">
        <div class="mini-card">
            <div>
                <div class="mini-label">Spitz</div>
                <div class="mini-val" id="st-spitz">0</div>
            </div>
            <div class="mini-icon" style="color:var(--warning)">üê∂</div>
        </div>
        <div class="mini-card">
            <div>
                <div class="mini-label">Bengal</div>
                <div class="mini-val" id="st-bengal">0</div>
            </div>
            <div class="mini-icon" style="color:var(--danger)">üêØ</div>
        </div>
        <div class="mini-card">
            <div>
                <div class="mini-label">Machos</div>
                <div class="mini-val" id="st-m">0</div>
            </div>
            <div class="mini-icon" style="color:var(--primary)">üíô</div>
        </div>
        <div class="mini-card">
            <div>
                <div class="mini-label">F√™meas</div>
                <div class="mini-val" id="st-f">0</div>
            </div>
            <div class="mini-icon" style="color:#e84393">üíñ</div>
        </div>
    </div>

    <div class="finance-grid">
        <div class="card c-bruto">
            <h3>Vendas + Sinais (Base)</h3>
            <span class="value" id="valBruto">R$ 0,00</span>
            <span class="sub" id="txtQtd">0 Registros</span>
        </div>
        <div class="card c-comissao">
            <h3>Comiss√£o Total</h3>
            <span class="value" style="color:var(--text)" id="valComissao">R$ 0,00</span>
            <span class="sub">Fixo (2k) + 3% Bruto</span>
        </div>
        <div class="card c-vale">
            <h3>(-) Adiantamentos</h3>
            <span class="value" id="valVales">R$ 0,00</span>
            <span class="sub">Descontado do final</span>
        </div>
        <div class="card c-liquido">
            <h3>Saldo Final (L√≠quido)</h3>
            <span class="value" id="valLiquido">R$ 0,00</span>
            <span class="sub">Dispon√≠vel para saque</span>
        </div>
    </div>

    <div class="chart-wrapper">
        <canvas id="mainChart"></canvas>
    </div>

    <div class="input-bar no-print">
        <select id="inRaca">
            <option value="Spitz">Spitz Alem√£o üê∂</option>
            <option value="Bengal">Gato Bengal üêØ</option>
            <option value="Outros">Outros</option>
        </select>
        <select id="inSexo">
            <option value="M">Macho üíô</option>
            <option value="F">F√™mea üíñ</option>
        </select>
        <input type="text" id="inCli" placeholder="Nome do Cliente" style="flex-grow: 2;">
        <input type="number" id="inVal" placeholder="Valor R$" style="width:120px;">
        <button class="btn-add" onclick="addReg()">LAN√áAR</button>
        <button class="btn-vale-action" onclick="addVale()">REGISTRAR VALE</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Status</th>
                    <th>Cliente / Pet</th>
                    <th>Valor</th>
                    <th>Comiss√£o (3%)</th>
                    <th class="no-print" style="text-align:right">A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="lista"></tbody>
        </table>
    </div>

</div>

<script>
    const FINAL_KEY = 'MYBABY_FINAL_SYSTEM_V15';
    let db = { vendas: [] };
    let chartInst = null;

    // --- SISTEMA DE RESGATE DE DADOS ANTIGOS ---
    function loadDB() {
        // Lista de chaves usadas nas vers√µes anteriores
        const oldKeys = [
            FINAL_KEY, 
            'NEON_PRIME_DATA_V14', 
            'GERSON_COMISSOES_V13', 
            'MY_BABY_V12_SYSTEM', 
            'MY_BABY_V11_FINAL', 
            'MY_BABY_V10_DATA'
        ];

        let found = false;

        // Procura do mais recente para o mais antigo
        for (let key of oldKeys) {
            const raw = localStorage.getItem(key);
            if (raw) {
                try {
                    const parsed = JSON.parse(raw);
                    // Normaliza (algumas vers√µes eram array, outras objeto)
                    const lista = Array.isArray(parsed) ? parsed : (parsed.vendas || []);
                    
                    if (lista.length > 0) {
                        db.vendas = lista;
                        console.log("Dados recuperados de: " + key);
                        found = true;
                        break; 
                    }
                } catch(e) {}
            }
        }

        // Se encontrou dados antigos mas ainda n√£o salvou na nova chave, salva agora
        if(found) {
            saveDB();
        }

        document.getElementById('dataPrint').innerText = new Date().toLocaleDateString();
        render();
    }

    function saveDB() {
        localStorage.setItem(FINAL_KEY, JSON.stringify(db));
        render();
    }

    // --- FUN√á√ïES DE ARQUIVO ---
    function exportData() {
        const str = JSON.stringify(db);
        const blob = new Blob([str], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Backup_Vendas_${new Date().toLocaleDateString().replace(/\//g,'-')}.json`;
        a.click();
    }

    function importData(input) {
        const f = input.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                // Valida√ß√£o b√°sica
                if(json.vendas || Array.isArray(json)) {
                    db = json.vendas ? json : { vendas: json };
                    saveDB();
                    alert("Importado com sucesso!");
                }
            } catch(x) { alert("Arquivo inv√°lido"); }
        };
        r.readAsText(f);
    }

    // --- L√ìGICA DE NEG√ìCIO ---
    function addReg() {
        const cli = document.getElementById('inCli').value;
        const val = parseFloat(document.getElementById('inVal').value);
        if(cli && val) {
            db.vendas.push({
                id: Date.now(),
                data: new Date().toLocaleDateString('pt-BR').substring(0,5),
                tipo: 'venda',
                cliente: cli,
                raca: document.getElementById('inRaca').value,
                sexo: document.getElementById('inSexo').value,
                valor: val,
                cancelada: false
            });
            document.getElementById('inCli').value = '';
            document.getElementById('inVal').value = '';
            saveDB();
        }
    }

    function addVale() {
        const val = prompt("Valor do Vale:");
        if(val) {
            db.vendas.push({
                id: Date.now(),
                data: new Date().toLocaleDateString('pt-BR').substring(0,5),
                tipo: 'vale',
                cliente: 'ADIANTAMENTO',
                valor: parseFloat(val)
            });
            saveDB();
        }
    }

    function toggleStatus(id) {
        const item = db.vendas.find(x => x.id === id);
        if(item) {
            item.cancelada = !item.cancelada;
            saveDB();
        }
    }

    function del(id) {
        if(confirm("Apagar registro?")) {
            db.vendas = db.vendas.filter(x => x.id !== id);
            saveDB();
        }
    }

    // --- RENDER ---
    function render() {
        const tbody = document.getElementById('lista');
        tbody.innerHTML = '';

        let finance = { bruto: 0, comissao: 0, vales: 0 };
        let stats = { spitz: 0, bengal: 0, m: 0, f: 0 };
        let chartL = [], chartD = [];

        // Ordena por ID (Data)
        const sorted = [...db.vendas].sort((a,b) => a.id - b.id);

        sorted.forEach(v => {
            if(v.tipo === 'vale') {
                finance.vales += v.valor;
            } else {
                // SOMA TUDO (Ativo ou Cancelado/Sinal)
                finance.bruto += v.valor;
                finance.comissao += (v.valor * 0.03);

                // Stats
                if(v.raca === 'Spitz') stats.spitz++;
                if(v.raca === 'Bengal') stats.bengal++;
                if(v.sexo === 'M') stats.m++;
                if(v.sexo === 'F') stats.f++;

                // Chart
                chartL.push(v.data);
                chartD.push(v.valor);
            }
        });

        const totalComissao = 2000 + finance.comissao;
        const liquido = totalComissao - finance.vales;

        // Atualiza HTML
        document.getElementById('st-spitz').innerText = stats.spitz;
        document.getElementById('st-bengal').innerText = stats.bengal;
        document.getElementById('st-m').innerText = stats.m;
        document.getElementById('st-f').innerText = stats.f;

        document.getElementById('valBruto').innerText = `R$ ${finance.bruto.toLocaleString('pt-BR')}`;
        document.getElementById('txtQtd').innerText = `${sorted.filter(x=>x.tipo!='vale').length} Vendas Totais`;
        document.getElementById('valComissao').innerText = `R$ ${totalComissao.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
        document.getElementById('valVales').innerText = `R$ ${finance.vales.toLocaleString('pt-BR')}`;
        document.getElementById('valLiquido').innerText = `R$ ${liquido.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;

        // Atualiza Tabela (Invertida)
        [...sorted].reverse().forEach(v => {
            if(v.tipo === 'vale') {
                tbody.innerHTML += `
                    <tr class="row-vale">
                        <td>${v.data}</td>
                        <td><span class="badge b-vale">VALE</span></td>
                        <td><b>ADIANTAMENTO</b></td>
                        <td>- R$ ${v.valor.toLocaleString()}</td>
                        <td>-</td>
                        <td class="no-print" style="text-align:right">
                            <button class="act-btn" onclick="del(${v.id})">üóë</button>
                        </td>
                    </tr>`;
            } else {
                const isCancel = v.cancelada;
                const statusBadge = isCancel 
                    ? `<span class="badge b-cancel">SINAL / CANCEL</span>` 
                    : `<span class="badge b-ok">ENTREGUE</span>`;
    
