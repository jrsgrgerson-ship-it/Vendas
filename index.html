<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Vendas Canil My Baby</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* TEMA AZUL NEON V24 */
            --bg-deep: #020617;       
            --bg-glass: rgba(15, 23, 42, 0.7);
            --border: 1px solid rgba(56, 189, 248, 0.2);
            --neon-blue: #00f2ff;     
            --neon-glow: 0 0 15px rgba(0, 242, 255, 0.3);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #4ade80;       
            --danger: #f87171;        
            --warning: #facc15;       
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        
        body { 
            background: var(--bg-deep); color: var(--text-main); 
            padding: 20px; min-height: 100vh;
            background-image: radial-gradient(at top center, #0f172a 0%, #020617 80%);
        }

        .container { max-width: 1200px; margin: 0 auto; padding-bottom: 50px; }

        /* HEADER */
        header {
            display: flex; justify-content: space-between; align-items: flex-end;
            padding-bottom: 20px; border-bottom: var(--border); margin-bottom: 20px;
        }
        .title-block h1 { 
            font-weight: 800; font-size: 26px; text-transform: uppercase; letter-spacing: 1px; color: #fff;
        }
        .title-block h1 span { color: var(--neon-blue); text-shadow: var(--neon-glow); }
        .title-block p { color: var(--text-muted); font-size: 14px; font-weight: 300; margin-top: 5px; letter-spacing: 0.5px; }
        
        .tools button {
            background: rgba(255,255,255,0.05); border: var(--border); color: var(--neon-blue);
            padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: 0.3s;
            font-size: 11px; text-transform: uppercase; font-weight: 600; margin-left: 5px;
        }
        .tools button:hover { background: var(--neon-blue); color: #000; box-shadow: var(--neon-glow); }

        /* BARRA DE FILHOTES */
        .stats-bar {
            display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap;
            background: var(--bg-glass); padding: 15px; border-radius: 12px; border: var(--border);
            align-items: center;
        }
        .stat-item { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-muted); }
        .stat-item b { color: #fff; font-size: 18px; font-weight: 600; }
        .stat-sep { width: 1px; background: rgba(255,255,255,0.1); height: 20px; }

        /* CARDS */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card {
            background: var(--bg-glass); backdrop-filter: blur(10px);
            padding: 25px; border-radius: 16px; border: var(--border);
            transition: transform 0.3s;
        }
        .card:hover { transform: translateY(-5px); border-color: var(--neon-blue); }
        .card h3 { font-size: 11px; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1px; margin-bottom: 8px; }
        .card .value { font-size: 32px; font-weight: 700; display: block; margin-bottom: 5px; }
        .card .sub { font-size: 12px; opacity: 0.5; }

        .c-fat .value { color: #fff; text-shadow: 0 0 15px rgba(255,255,255,0.1); }
        .c-desc .value { color: var(--danger); }
        .c-final { border: 1px solid var(--neon-blue); background: linear-gradient(145deg, rgba(0,242,255,0.05), transparent); }
        .c-final .value { color: var(--neon-blue); text-shadow: var(--neon-glow); }

        /* GR√ÅFICO */
        .chart-container {
            background: var(--bg-glass); padding: 20px; border-radius: 16px; border: var(--border);
            height: 300px; margin-bottom: 30px;
        }

        /* INPUTS */
        .control-panel {
            background: #0f172a; padding: 20px; border-radius: 16px; border: var(--border);
            display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; align-items: center;
        }
        select, input {
            background: #020617; border: 1px solid #334155; color: #fff;
            padding: 12px; border-radius: 8px; outline: none; font-size: 14px;
        }
        input:focus { border-color: var(--neon-blue); box-shadow: var(--neon-glow); }

        .btn-lancar {
            background: var(--neon-blue); color: #020617; border: none; padding: 12px 25px;
            border-radius: 8px; font-weight: 800; cursor: pointer; flex-grow: 1; text-transform: uppercase;
        }
        .btn-vale {
            background: transparent; color: var(--danger); border: 1px solid var(--danger);
            padding: 12px 20px; border-radius: 8px; font-weight: 700; cursor: pointer;
        }

        /* TABELA */
        .table-wrap { overflow-x: auto; border: var(--border); border-radius: 16px; background: var(--bg-glass); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 18px; color: var(--text-muted); font-size: 11px; text-transform: uppercase; border-bottom: 1px solid #334155; }
        td { padding: 18px; border-bottom: 1px solid #1e293b; font-size: 14px; }
        
        .tag { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .t-ok { color: var(--success); border: 1px solid var(--success); background: rgba(74,222,128,0.1); }
        .t-cancel { color: var(--warning); border: 1px solid var(--warning); background: rgba(250,204,21,0.1); }
        .t-vale { color: var(--danger); font-weight: bold; }

        .btn-act {
            border: none; background: rgba(255,255,255,0.05); color: #94a3b8;
            padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 10px; font-weight: 600;
            margin-right: 5px; transition: 0.2s; text-transform: uppercase;
        }
        .act-ok:hover { background: var(--success); color: #000; }
        .act-cancel:hover { background: var(--warning); color: #000; }
        .act-del:hover { background: var(--danger); color: #fff; }

        @media print {
            body { background: #fff; color: #000; background-image: none; }
            .no-print { display: none; }
            .card, .table-wrap, .chart-container, .stats-bar { 
                background: #fff; border: 1px solid #000; color: #000; box-shadow: none; 
            }
            .value { color: #000 !important; text-shadow: none !important; }
            h1 span { color: #000; text-shadow: none; }
            #headerPDF { display: block !important; margin-bottom: 20px; text-align: center; border-bottom: 2px solid #000; padding: 20px; }
        }
        #headerPDF { display: none; }
    </style>
</head>
<body>

<div class="container">
    
    <div id="headerPDF">
        <h2>Painel de Vendas Canil My Baby</h2>
        <p>Vendedor: Gerson | Data: <span id="dataPrint"></span></p>
    </div>

    <header class="no-print">
        <div class="title-block">
            <h1>Painel de Vendas <span>Canil My Baby</span></h1>
            <p>Vendedor Spitz e Bengal Gerson</p>
        </div>
        <div class="tools">
            <button onclick="buscarDadosBrutos()">‚ö†Ô∏è Recupera√ß√£o Total (Sem Filtros)</button>
            <button onclick="exportar()">üíæ Backup</button>
            <button onclick="window.print()">üñ®Ô∏è PDF</button>
        </div>
    </header>

    <div class="stats-bar">
        <div class="stat-item">üê∂ Spitz: <b id="st-spitz">0</b></div>
        <div class="stat-sep"></div>
        <div class="stat-item">üêØ Bengal: <b id="st-bengal">0</b></div>
        <div class="stat-sep"></div>
        <div class="stat-item" style="color:#38bdf8">üíô Machos: <b id="st-m">0</b></div>
        <div class="stat-sep"></div>
        <div class="stat-item" style="color:#f472b6">üíñ F√™meas: <b id="st-f">0</b></div>
    </div>

    <div class="grid">
        <div class="card c-fat">
            <h3>Faturamento (Bruto Integral)</h3>
            <span class="value" id="val-fat">R$ 0,00</span>
            <small id="txt-qtd">0 Registros</small>
        </div>
        <div class="card c-desc">
            <h3>Total Descontos</h3>
            <span class="value" id="val-desc">R$ 0,00</span>
            <small>Vales e Adiantamentos</small>
        </div>
        <div class="card c-final">
            <h3>Saldo Final (Comiss√µes)</h3>
            <span class="value" id="val-liq">R$ 0,00</span>
            <small>Fixo (2k) + 3% de Tudo - Vales</small>
        </div>
    </div>

    <div class="chart-container no-print">
        <canvas id="luxChart"></canvas>
    </div>

    <div class="control-panel no-print">
        <select id="inRaca" style="width:130px">
            <option value="Spitz">Spitz Alem√£o</option>
            <option value="Bengal">Gato Bengal</option>
            <option value="Outros">Outros</option>
        </select>
        <select id="inSexo" style="width:100px">
            <option value="M">Macho</option>
            <option value="F">F√™mea</option>
        </select>
        <input type="text" id="inCli" placeholder="Nome do Cliente" style="flex-grow:1">
        <input type="number" id="inVal" placeholder="Valor Integral R$" style="width:130px">
        <button class="btn-lancar" onclick="add(false)">Lan√ßar</button>
        <button class="btn-vale" onclick="add(true)">Lan√ßar Vale</button>
    </div>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Status</th>
                    <th>Detalhes</th>
                    <th>Valor Integral</th>
                    <th>Comiss√£o (3%)</th>
                    <th class="no-print" style="text-align:right">A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="lista"></tbody>
        </table>
    </div>
</div>

<script>
    const KEY_FINAL = 'MYBABY_GERSON_V24_FIXED';
    let db = { vendas: [] };
    let chartInst = null;

    // --- RECUPERA√á√ÉO SEM PERDA DE DADOS ---
    function buscarDadosBrutos() {
        if(!confirm("Isso vai buscar TUDO o que encontrar no navegador. Pode trazer duplicatas (melhor sobrar do que faltar). Continuar?")) return;
        
        let recover = [];
        let chavesLidas = 0;

        // Varre todas as chaves
        for(let i=0; i<localStorage.length; i++) {
            let key = localStorage.key(i);
            // Ignora chaves que n√£o sejam do sistema (pra n√£o pegar lixo de outros sites se n√£o estiver em sandbox)
            // Mas pega todas as vers√µes do MyBaby
            try {
                let raw = localStorage.getItem(key);
                let parsed = JSON.parse(raw);
                let items = null;

                if(Array.isArray(parsed)) items = parsed;
                else if(parsed.vendas && Array.isArray(parsed.vendas)) items = parsed.vendas;

                if(items && items.length > 0) {
                    // Detectou lista v√°lida
                    items.forEach(x => {
                        // Traduz Ra√ßa antiga
                        if(!x.raca && x.pet) {
                            if(x.pet.toLowerCase().includes('spitz')) x.raca = 'Spitz';
                            else if(x.pet.toLowerCase().includes('bengal')) x.raca = 'Bengal';
                            else x.raca = 'Outros';
                        }
                        if(!x.sexo) x.sexo = 'M';
                        if(x.vale === true || x.vale === 'true') x.tipo = 'vale';
                        if(!x.tipo) x.tipo = 'venda'; 
                        
                        recover.push(x);
                    });
                    chavesLidas++;
                }
            } catch(e){}
        }

        // Deduplica√ß√£o SUPER LEVE (S√≥ remove se for EXATAMENTE ID√äNTICO ID)
        // Se o ID for diferente, ele mant√©m, mesmo que cliente e valor sejam iguais.
        // Isso garante que vendas repetidas leg√≠timas n√£o sumam.
        let unique = [];
        let map = new Set();
        recover.forEach(r => {
            if(!r.id) r.id = Math.random();
            if(!map.has(r.id)) {
                map.add(r.id);
                unique.push(r);
            }
        });

        if(unique.length > 0) {
            db.vendas = unique;
            save();
            alert(`Varredura completa! ${unique.length} registros recuperados. Verifique se o total bateu 74k.`);
        } else {
            alert("Nenhum dado encontrado.");
        }
    }

    function init() {
        let s = localStorage.getItem(KEY_FINAL);
        if(s) {
            db = JSON.parse(s);
        } else {
            // Tenta recuperar automaticamente
            buscarDadosBrutos(); 
        }
        document.getElementById('dataPrint').innerText = new Date().toLocaleDateString();
        render();
    }

    function save() {
        localStorage.setItem(KEY_FINAL, JSON.stringify(db));
        render();
    }

    function add(isVale) {
        let cli = document.getElementById('inCli').value;
        let val = parseFloat(document.getElementById('inVal').value);
        if(isVale && !val) val = parseFloat(prompt("Valor do Vale:"));

        if(val) {
            db.vendas.push({
                id: Date.now(),
                data: new Date().toLocaleDateString('pt-BR').substring(0,5),
                tipo: isVale ? 'vale' : 'venda',
                cliente: isVale ? 'ADIANTAMENTO' : (cli || 'Cliente'),
                raca: document.getElementById('inRaca').value,
                sexo: document.getElementById('inSexo').value,
                valor: val,
                cancelada: false
            });
            save();
            document.getElementById('inCli').value = '';
            document.getElementById('inVal').value = '';
        }
    }

    function setStatus(id, status) {
        let item = db.vendas.find(x => x.id == id);
        if(item) {
            item.cancelada = status; // true = cancel/sinal
            save();
        }
    }

    function del(id) {
        if(confirm("Apagar registro permanentemente?")) {
            db.vendas = db.vendas.filter(x => x.id != id);
            save();
        }
    }

    function render() {
        let tbody = document.getElementById('lista');
        tbody.innerHTML = '';

        let fat = 0, desc = 0, comissao = 0;
        let stats = { spitz:0, bengal:0, m:0, f:0 };
        let labels = [], dataPoints = [];

        // Ordena√ß√£o por ID (cria√ß√£o)
        let sorted = [...db.vendas].sort((a,b) => a.id - b.id);

        sorted.forEach(v => {
            if(v.tipo === 'vale') {
                desc += v.valor;
            } else {
                // SOMA TUDO NO BRUTO (74k)
                fat += v.valor;
                comissao += (v.valor * 0.03);

                // Contadores com verifica√ß√£o robusta
                let raca = (v.raca || v.pet || '').toLowerCase();
                let sexo = (v.sexo || '').toLowerCase();

                if(raca.includes('spitz')) stats.spitz++;
                else if(raca.includes('bengal')) stats.bengal++;

                if(sexo.includes('m')) stats.m++;
                else if(sexo.includes('f')) stats.f++;

                labels.push(v.data);
                dataPoints.push(v.valor);
            }
        });

        // Atualiza UI Stats
        document.getElementById('st-spitz').innerText = stats.spitz;
        document.getElementById('st-bengal').innerText = stats.bengal;
        document.getElementById('st-m').innerText = stats.m;
        document.getElementById('st-f').innerText = stats.f;

        // Atualiza UI Financeiro
        let saldo = 2000 + comissao - desc;
        document.getElementById('val-fat').innerText = `R$ ${fat.toLocaleString('pt-BR')}`;
        document.getElementById('txt-qtd').innerText = `${sorted.filter(x=>x.tipo!='vale').length} Vendas`;
        document.getElementById('val-desc').innerText = `R$ ${desc.toLocaleString('pt-BR')}`;
        document.getElementById('val-liq').innerText = `R$ ${saldo.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;

        // Tabela
        [...sorted].reverse().forEach(v => {
            let tr = document.createElement('tr');
            
            if(v.tipo === 'vale') {
                tr.innerHTML = `
                    <td>${v.data}</td>
                    <td><span class="tag t-vale">VALE</span></td>
                    <td style="color:var(--danger)">ADIANTAMENTO</td>
                    <td style="color:var(--danger)">- R$ ${v.valor.toLocaleString()}</td>
                    <td>-</td>
                    <td class="no-print" style="text-align:right">
                        <button class="btn-act act-del" onclick="del(${v.id})">üóë</button>
                    </td>
                `;
            } else {
                let isCancel = v.cancelada;
                let badge = isCancel 
                    ? `<span class="tag t-cancel">‚ö†Ô∏è SINAL / CANCEL</span>` 
                    : `<span class="tag t-ok">‚úÖ ENTREGUE</span>`;
                
                // Exibe valor integral mesmo cancelado, com nota "SINAL"
                let valDisplay = isCancel
                    ? `<span style="text-decoration:line-through; opacity:0.5">R$ ${v.valor.toLocaleString()}</span> <span style="font-size:11px; color:var(--warning)">SINAL</span>`
                    : `R$ ${v.valor.toLocaleString()}`;

                tr.innerHTML = `
                    <td>${v.data}</td>
                    <td>${badge}</td>
                    <td>
                        <b>${v.cliente}</b> <span style="color:var(--text-muted); font-size:12px">| ${v.raca} (${v.sexo})</span>
                    </td>
                    <td>${valDisplay}</td>
                    <td style="color:var(--neon-blue); font-weight:700">+ R$ ${(v.valor * 0.03).toLocaleString('pt-BR', {minimumFractionDigits:2})}</td>
                    <td class="no-print" style="text-align:right">
                        <button class="btn-act act-ok" onclick="setStatus(${v.id}, false)">Entregue</button>
                        <button class="btn-act act-cancel" onclick="setStatus(${v.id}, true)">Cancelou</button>
                        <button class="btn-act act-del" onclick="del(${v.id})">üóë</button>
                    </td>
                `;
            }
            tbody.appendChild(tr);
        });

        drawChart(labels, dataPoints);
    }

    function drawChart(lbls, vals) {
        const ctx = document.getElementById('luxChart').getContext('2d');
        if(chartInst) chartInst.destroy();

        let grad = ctx.createLinearGradient(0, 0, 0, 400);
        grad.addColorStop(0, 'rgba(0, 242, 255, 0.4)');
        grad.addColorStop(1, 'rgba(0, 242, 255, 0)');

        chartInst = new Chart(ctx, {
            type: 'line',
            data: {
                labels: lbls,
                datasets: [{
                    label: 'Vendas',
                    data: vals,
                    borderColor: '#00f2ff',
                    backgroundColor: grad,
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 0, 
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#94a3b8' } },
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                }
            }
        });
    }

    functio
