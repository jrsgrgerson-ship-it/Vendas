<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY BABY ULTIMATE | GERSON EDITION 2026</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #0066ff;
            --success: #00c853;
            --danger: #ff1744;
            --warning: #ff9100;
            --bg: #ffffff;
            --surface: #f8f9fa;
            --text: #1a1c1e;
            --text-sub: #6c757d;
            --border: #e9ecef;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }

        .container { max-width: 1100px; margin: auto; }

        /* HEADER */
        .header { 
            display: flex; justify-content: space-between; align-items: flex-end; 
            margin-bottom: 40px; border-bottom: 2px solid var(--surface); padding-bottom: 20px;
        }
        .header h1 { margin: 0; font-weight: 800; font-size: 28px; letter-spacing: -1.5px; }
        .header p { margin: 0; color: var(--text-sub); font-weight: 500; }

        /* DASHBOARD CARDS */
        .grid-stats { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); 
            gap: 20px; margin-bottom: 30px; 
        }
        .stat-card { 
            background: var(--surface); padding: 25px; border-radius: 20px; 
            border: 1px solid var(--border); transition: all 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: var(--shadow); border-color: var(--primary); }
        .stat-card h3 { margin: 0; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); }
        .stat-card .value { font-size: 32px; font-weight: 800; display: block; margin: 10px 0; }
        .stat-card .footer-stat { font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 5px; }

        .card-dark { background: var(--text); color: white; border: none; }
        .card-dark h3 { color: #adb5bd; }
        .card-dark .value { color: var(--success); }

        /* CHART AREA */
        .chart-wrapper { 
            background: #fff; padding: 25px; border-radius: 24px; border: 1px solid var(--border); 
            margin-bottom: 30px; height: 320px; box-shadow: var(--shadow);
        }

        /* FORMUL√ÅRIO DENSO */
        .action-bar { 
            background: var(--surface); padding: 25px; border-radius: 20px; 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; margin-bottom: 30px; align-items: flex-end;
        }
        .input-box { display: flex; flex-direction: column; gap: 8px; }
        .input-box label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-sub); }
        input, select { 
            padding: 14px; border: 1px solid var(--border); border-radius: 12px; 
            font-size: 15px; font-weight: 500; outline: none; transition: 0.2s;
        }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(0, 102, 255, 0.1); }

        .btn-main { 
            background: var(--primary); color: white; border: none; padding: 15px; 
            border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.2s;
        }
        .btn-main:hover { background: #0052cc; transform: scale(1.02); }

        .btn-vale { 
            grid-column: 1 / -1; background: transparent; border: 2px dashed var(--danger); 
            color: var(--danger); padding: 12px; border-radius: 12px; font-weight: 700; cursor: pointer;
        }

        /* TABELA DE ALTA QUALIDADE */
        .table-wrap { 
            background: white; border-radius: 24px; border: 1px solid var(--border); 
            overflow: hidden; box-shadow: var(--shadow);
        }
        table { width: 100%; border-collapse: collapse; }
        th { background: #fcfcfc; padding: 18px; text-align: left; font-size: 11px; text-transform: uppercase; color: var(--text-sub); border-bottom: 2px solid var(--surface); }
        td { padding: 18px; border-bottom: 1px solid var(--surface); font-size: 14px; font-weight: 500; }

        tr.cancelado { background: #fafafa; }
        tr.cancelado .txt-bruto { text-decoration: line-through; color: #adb5bd; }
        
        .badge { padding: 6px 12px; border-radius: 8px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
        .badge-ok { background: #e8f5e9; color: #2e7d32; }
        .badge-err { background: #ffebee; color: #c62828; }
        .badge-vale { background: #fff3e0; color: #ef6c00; }

        .col-acoes { display: flex; gap: 8px; justify-content: flex-end; }
        .btn-action { 
            width: 38px; height: 38px; border-radius: 10px; border: 1px solid var(--border); 
            background: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .btn-action:hover { background: var(--surface); border-color: var(--primary); }
        .btn-del:hover { background: #fff1f2; border-color: var(--danger); color: var(--danger); }

        /* MOBILE */
        @media (max-width: 768px) {
            .grid-stats { grid-template-columns: 1fr; }
            .action-bar { grid-template-columns: 1fr; }
            th:nth-child(3), td:nth-child(3) { display: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>MY BABY <span style="color:var(--primary)">ULTIMATE</span></h1>
            <p>Gest√£o Financeira Gerson Edition</p>
        </div>
        <div style="text-align: right;">
            <button onclick="exportarBackup()" style="font-size: 11px; background: none; border: 1px solid var(--border); padding: 5px 10px; border-radius: 5px; cursor: pointer;">Backup Geral</button>
        </div>
    </div>

    <div class="grid-stats">
        <div class="stat-card">
            <h3>Faturamento Mensal (L√≠quido)</h3>
            <span class="value" id="fatAtivo">R$ 0,00</span>
            <div class="footer-stat" id="metaLabel" style="color: var(--primary);">Progresso Meta: 0%</div>
        </div>
        <div class="stat-card card-dark">
            <h3>Saldo Final Gerson</h3>
            <span class="value" id="saldoFinal">R$ 0,00</span>
            <div class="footer-stat" id="comissaoSub">Fixo R$ 2000 + Comiss√µes</div>
        </div>
        <div class="stat-card">
            <h3>Vales & Retiradas</h3>
            <span class="value" style="color: var(--danger);" id="totalVales">R$ 0,00</span>
            <div class="footer-stat" id="countVales">0 registros</div>
        </div>
    </div>

    <div class="chart-wrapper">
        <canvas id="liquidChart"></canvas>
    </div>

    <div class="action-bar">
        <div class="input-box">
            <label>Tipo de Venda</label>
            <select id="inTipo">
                <option value="Spitz Alem√£o">üê∂ Spitz Alem√£o</option>
                <option value="Gato Bengal">üê± Gato Bengal</option>
            </select>
        </div>
        <div class="input-box">
            <label>Cliente</label>
            <input type="text" id="inCliente" placeholder="Nome do Cliente">
        </div>
        <div class="input-box">
            <label>Valor Bruto</label>
            <input type="number" id="inValor" placeholder="R$ 0,00">
        </div>
        <button class="btn-main" onclick="novaVenda()">LAN√áAR VENDA</button>
        <button class="btn-vale" onclick="novoVale()">+ REGISTRAR NOVO VALE / ADIANTAMENTO</button>
    </div>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Detalhes do Cliente</th>
                    <th>Valor Bruto</th>
                    <th>Sua Comiss√£o (3%)</th>
                    <th style="text-align: right;">A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="tabelaCorpo"></tbody>
        </table>
    </div>

</div>

<script>
    // --- O MOTOR DE RESGATE DE DADOS (CR√çTICO) ---
    function resgatarDados() {
        const chavesHistoricas = ['vendasV5', 'db_mybaby_v6', 'vendasV6', 'mybaby_data', 'vendasV4'];
        let baseUnificada = [];
        let metaUnificada = 74000;

        chavesHistoricas.forEach(chave => {
            const dado = localStorage.getItem(chave);
            if (dado) {
                try {
                    const parseado = JSON.parse(dado);
                    // Lida se o dado for um objeto {vendas: [], meta: X} ou apenas o array []
                    const arrayVendas = Array.isArray(parseado) ? parseado : (parseado.vendas || []);
                    baseUnificada = baseUnificada.concat(arrayVendas);
                    if (parseado.meta) metaUnificada = parseado.meta;
                } catch(e) { console.log("Erro ao ler chave " + chave); }
            }
        });

        // Limpeza de duplicados por ID ou timestamp
        const listaLimpa = [];
        const idsVistos = new Set();
        baseUnificada.forEach(v => {
            const identificador = v.id || `${v.cliente}-${v.valor}-${v.data}`;
            if (!idsVistos.has(identificador)) {
                idsVistos.add(identificador);
                listaLimpa.push(v);
            }
        });

        return { vendas: listaLimpa, meta: metaUnificada };
    }

    let memoria = resgatarDados();
    let chartInstance = null;

    function salvar() {
        localStorage.setItem('vendasV5', JSON.stringify(memoria.vendas));
        // Salva na V5 para manter compatibilidade com o hist√≥rico principal
        render();
    }

    function novaVenda() {
        const cli = document.getElementById('inCliente').value;
        const val = parseFloat(document.getElementById('inValor').value);
        if (cli && val) {
            memoria.vendas.push({
                id: Date.now(),
                data: new Date().toLocaleDateString('pt-BR').substring(0, 5),
                cliente: cli,
                tipo: document.getElementById('inTipo').value,
                valor: val,
                cancelada: false,
                isVale: false
            });
            document.getElementById('inCliente').value = '';
            document.getElementById('inValor').value = '';
            salvar();
        }
    }

    function novoVale() {
        const v = prompt("Valor do Vale / Retirada:");
        if (v) {
            memoria.vendas.push({
                id: Date.now(),
                data: new Date().toLocaleDateString('pt-BR').substring(0, 5),
                cliente: "VALE / ADIANTAMENTO",
                valor: parseFloat(v),
                isVale: true
            });
            salvar();
        }
    }

    function toggleStatus(id) {
        const idx = memoria.vendas.findIndex(v => v.id === id);
        if (idx !== -1) {
            memoria.vendas[idx].cancelada = !memoria.vendas[idx].cancelada;
            salvar();
        }
    }

    function remover(id) {
        if (confirm("Deseja apagar permanentemente?")) {
            memoria.vendas = memoria.vendas.filter(v => v.id !== id);
            salvar();
        }
    }

    // --- RENDERIZA√á√ÉO E MATEM√ÅTICA ---
    function render() {
        const corpo = document.getElementById('tabelaCorpo');
        corpo.innerHTML = '';
        
        let somaComissao = 0;
        let somaVales = 0;
        let fatLiquido = 0;
        let contV = 0;
        let ptsChart = {};

        // Loop de processamento
        memoria.vendas.forEach(v => {
            if (v.isVale) {
                somaVales += v.valor;
                contV++;
            } else {
                // MATEM√ÅTICA BLINDADA: Adiciona 3% de TUDO antes de ver se cancelou
                somaComissao += (v.valor * 0.03);

                if (!v.cancelada) {
                    fatLiquido += v.valor;
                    ptsChart[v.data] = (ptsChart[v.data] || 0) + v.valor;
                }
            }
        });

        const saldoFinalGerson = 2000 + somaComissao - somaVales;

        // Atualizar Dashboard
        document.getElementById('fatAtivo').innerText = `R$ ${fatLiquido.toLocaleString('pt-BR')}`;
        document.getElementById('saldoFinal').innerText = `R$ ${saldoFinalGerson.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        document.getElementById('totalVales').innerText = `R$ ${somaVales.toLocaleString('pt-BR')}`;
        document.getElementById('comissaoSub').innerText = `Fixo R$ 2000 + Comiss√µes (R$ ${somaComissao.toLocaleString('pt-BR')})`;
        document.getElementById('countVales').innerText = `${contV} registros realizados`;

        const pctMeta = (fatLiquido / memoria.meta) * 100;
        document.getElementById('metaLabel').innerText = `Progresso Meta: ${Math.floor(pctMeta)}% (Ref R$ ${memoria.meta.toLocaleString()})`;

        // Tabela
        [...memoria.vendas].reverse().forEach(v => {
            if (v.isVale) {
                corpo.innerHTML += `
                <tr style="background:#fffcfc">
                    <td>${v.data}</td>
                    <td><span class="badge badge-vale">üí∏ VALE / RETIRADA</span></td>
                    <td style="color:var(--danger); font-weight:700">- R$ ${v.valor.toLocaleString()}</td>
                    <td>-</td>
                    <td class="col-acoes"><button class="btn-action btn-del" onclick="remover(${v.id})">üóëÔ∏è</button></td>
                </tr>`;
            } else {
                corpo.innerHTML += `
                <tr class="${v.cancelada ? 'cancelado' : ''}">
                    <td>${v.data}</td>
                    <td>
                        <div style="font-weight:700">${v.cliente}</div>
                        <div style="font-size:11px; color:var(--text-sub)">${v.tipo}</div>
                        <span class="badge ${v.cancelada ? 'badge-err' : 'badge-ok'}">${v.cancelada ? 'Cancelada' : 'Ativa'}</span>
                    </td>
                    <td class="txt-bruto">R$ ${v.valor.toLocaleString()}</td>
                    <td style="color:var(--success); font-weight:800">+ R$ ${(v.valor * 0.03).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td class="col-acoes">
                        <button class="btn-action" title="Toggle Status" onclick="toggleStatus(${v.id})">üö´</button>
                        <button class="btn-action btn-del" title="Excluir" onclick="remover(${v.id})">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }
        });

        updateChart(ptsChart);
    }

    function updateChart(dados) {
        const ctx = document.getElementById('liquidChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Object.keys(dados),
                datasets: [{
                    label: 'Vendas Di√°rias',
                    data: Object.values(dados),
                    borderColor: '#0066ff',
                    borderWidth: 4,
                    tension: 0.4,
                    fill: true,
                    backgroundColor: 'rgba(0, 102, 255, 0.03)',
                    pointRadius: 5,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#0066ff',
                    pointBorderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false } },
                    y: { border: { display: false }, grid: { color: '#f8f9fa' } }
                }
            }
        });
    }

    function exportarBackup() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(memoria));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "my_baby_backup.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    // Iniciar
    render();
</script>

</body>
</html>
